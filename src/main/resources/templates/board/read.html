<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/basic.html}">
<head>
	<title>Board Read</title>
</head>

<div layout:fragment="content">
	<div class="row mt-3">
		<div class="col">
			<div class="card">
				<div class="card-header">
					Board Read
				</div>
				<div class="card-body">
					<div class="input-group mb-3">
						<span class="input-group-text">Bno</span>
						<input type="text" class="form-control" th:value="${dto.bno}" readonly/>
					</div>
					<div class="input-group mb-3">
						<span class="input-group-text">Title</span>
						<input type="text" class="form-control" th:value="${dto.title}" readonly/>
					</div>
					<div class="input-group mb-3">
						<span class="input-group-text">Content</span>
						<textarea class="form-control col-sm-5" rows="5" readonly>
							[[${dto.content}]]
						</textarea>
					</div>
					<div class="input-group mb-3">
						<span class="input-group-text">Writer</span>
						<input type="text" class="form-control" th:value="${dto.writer}" readonly/>
					</div>
					<div class="input-group mb-3">
						<span class="input-group-text">RegDate</span>
						<input type="text" class="form-control" 
						th:value="${#temporals.format(dto.regDate,'yyyy-MM-dd HH:mm:ss')}" readonly/>
					</div>
					<div class="input-group mb-3">
						<span class="input-group-text">ModDate</span>
						<input type="text" class="form-control" 
						th:value="${#temporals.format(dto.modDate,'yyyy-MM-dd HH:mm:ss')}" readonly/>
					</div>
					<div class="my-4">
						<div class="float-end" th:with="link = ${pageRequestDTO.getLink()}">
							<a th:href="|@{/board/list}?${link}|" class="text-decoration-none">
								<button type="button" class="btn btn-primary">List</button>
							</a>
							<a th:href="|@{/board/modify(bno=${dto.bno})}&${link}|" 
								class="text-decoration-none">
								<button type="button" class="btn btn-secondary">Modify</button>
							</a>
						</div>
					</div>
				</div> <!-- end card body -->
			</div> <!-- end card -->
		</div> <!-- end col -->
	</div> <!-- end row -->
	
	<div class="row mt-3">
		<div class="col-md-12">
			<div class="my-4">
				<button class="btn btn-info addReplyBtn">ADD REPLY</button>
			</div>
			<ul class="list-group replyList">
				reply List
			</ul>
		</div>
	</div>
	
	<div class="row mt-3">
		<div class="col">
			<ul class="pagination replyPaging">
				reply Paging
			</ul>
		</div>
	</div>
	
   <div class="modal registerModal" tabindex="-1">
       <div class="modal-dialog">
           <div class="modal-content">
               <div class="modal-header">
                   <h5 class="modal-title">Register Reply</h5>
                   <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
               </div>
               <div class="modal-body">
                   <div class="input-group mb-3">
                       <span class="input-group-text">Reply Text</span>
                       <input type="text" class="form-control replyText" >
                   </div>
                   <div class="input-group mb-3">
                       <span class="input-group-text">Replyer</span>
                       <input type="text" class="form-control replyer" >
                   </div>
               </div>
               <div class="modal-footer">
                   <button type="button" class="btn btn-primary registerBtn">Register</button>
                   <button type="button" class="btn btn-outline-dark closeRegisterBtn" >Close</button>
               </div>
           </div>
       </div>
   </div>
   <!-- end regist modal -->
	
   <div class="modal modifyModal" tabindex="-1">
       <div class="modal-dialog">
           <div class="modal-content">
               <div class="modal-header">
                   <h5 class="modal-title replyHeader"></h5>
                   <button type="button" class="btn-close" 
                   data-bs-dismiss="modal" aria-label="Close"></button>
               </div>
               <div class="modal-body">
                   <div class="input-group mb-3">
                       <span class="input-group-text">Reply Text</span>
                       <input type="text" class="form-control modifyText" >
                   </div>
               </div>
               <div class="modal-footer">
                   <button type="button" class="btn btn-primary modifyBtn">Modify</button>
                   <button type="button" class="btn btn-danger removeBtn">Remove</button>
                   <button type="button" class="btn btn-outline-dark closeRegisterBtn" >Close</button>
               </div>
           </div>
       </div>
   </div>
   <!-- end modify modal -->
	
	<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="/js/reply.js"></script>
</div>

<script layout:fragment="script" th:inline="javascript">
	/* getList()호출 */
	const bno = [[${dto.bno}]];
	const replyList = document.querySelector('.replyList');
	const replyPaging = document.querySelector('.replyPaging');
	
	function printReplies(page,size,goLast){
		getList({bno,page,size,goLast}).then(
				data => {
					console.log(data); //{page: 1, size: 10, total: 1, start: 1, end: 1, …}
					printList(data.dtoList);//목록 처리
					printPages(data); //페이지 처리
				}
			).catch(e => {
				console.error(e);
			});
	}

	
	/* 댓글 목록 출력 */
	function printList(dtoList){
		let str = '';
		if(dtoList && dtoList.length > 0){
			for(const dto of dtoList){
				str += `<li class="list-group-item d-flex replyItem">
						<span class="col-2">${dto.rno}</span>
						<span class="col-6" data-rno="${dto.rno}">${dto.replyText}</span>
						<span class="col-2">${dto.replyer}</span>
						<span class="col-2">${dto.regDate}</span>
					</li>`;
			}
		}
		replyList.innerHTML = str;
	}
	
	/* 페이지 목록 출력 */
	function printPages(data){
		//pagination
		let pageStr = '';
		
		if(data.prev){
			pageStr += `<li class="page-item">
				<a class="page-link" data-page="${data.start-1}">PREV</a>						
			</li>`;
		}
		
		for(let i=data.start; i<=data.end; i++){
			pageStr += `<li class="page-item ${i == data.page?'active':''}">
				<a class="page-link" data-page="${i}">${i}</a>						
			</li>`;
		}
		
		if(data.next){
			pageStr += `<li class="page-item">
				<a class="page-link" data-page="${data.end+1}">NEXT</a>						
			</li>`;
		}
		replyPaging.innerHTML = pageStr;
	}
	printReplies(1,10,true);//처음은 무조건 호출!!
	
   //댓글 등록 모달
   const registerModal = new bootstrap.Modal(document.querySelector(".registerModal"))
   //registerModel
   const registerBtn = document.querySelector(".registerBtn")
   const replyText = document.querySelector(".replyText")
   const replyer = document.querySelector(".replyer")
   const closeRegisterBtn = document.querySelector(".closeRegisterBtn")
   
	 document.querySelector(".addReplyBtn").addEventListener("click", function (e){
        registerModal.show()
    },false);

    closeRegisterBtn.addEventListener("click", function (e){
        registerModal.hide()
    },false);
   
    /*댓글 등록 이벤트 등록*/
   registerBtn.addEventListener("click",function(e){
	   const replyObj = {
			   bno : bno,
			   replyText : replyText.value,
			   replyer : replyer.value
	   };
	   addReply(replyObj).then(result => {
		   alert(result.rno);//생성된 댓글의 번호
		   registerModal.hide();
		   replyText.value = '';
		   replyer.value = '';
			printReplies(1,10,true);//댓글 목록 갱신
	   }).catch(e => {
		   alert("Exception...");
	   });
   },false);
   
   /*페이지 이동 이벤트 등록*/
   let page = 1;
   let size = 10;
   replyPaging.addEventListener("click",function(e){
	   e.preventDefault();
	   e.stopPropagation();
	   const target = e.target;//ul태그아닌감 클릭한건,a태그인듯
	   if(!target || target.tagName != 'A'){
		   return;
	   }
	   const pageNum = target.getAttribute("data-page");
	   page = pageNum;//누른 페이지 값 대입
		 printReplies(page,size);
   },false);
   
   //modifyModal
   const modifyModal = new bootstrap.Modal(document.querySelector(".modifyModal"))
   const replyHeader = document.querySelector(".replyHeader")
   const modifyText = document.querySelector(".modifyText")
   const modifyBtn = document.querySelector(".modifyBtn")
   const removeBtn = document.querySelector(".removeBtn")
   const closeModifyBtn = document.querySelector(".closeModifyBtn")
   
   /*댓글 조회 이벤트 처리*/
   //댓글 눌렀을 때, modal창 보여주어서 수정 혹은 삭제 가능하게
   replyList.addEventListener("click",function(e){
	   e.preventDefault();
	   e.stopPropagation();
	   const target = e.target;
	   if(!target || target.tagName != 'SPAN'){
		   return;
	   }
	   const rno = target.getAttribute("data-rno");
	   if(!rno){
		   return;
	   }
	   //getReply : 댓글 한 건 조회 axios
	   getReply(rno).then(reply => {
		   //댓글의 내용을 모달창에 채워서 보여주는
		   console.log(reply);
		   replyHeader.innerHTML = reply.rno;
		   modifyText.value = reply.replyText;
		   modifyModal.show();
	   }).catch(e => alert('error'));
   },false);
   
   /*댓글 수정 이벤트 처리*/
   modifyBtn.addEventListener("click",function(e){
	   const replyObj = {
			   bno:bno,
		     rno:replyHeader.innerHTML,
			   replyText : modifyText.value
	   };
	   //수정 axios호출
	   modifyReply(replyObj).then(result => {
		   alert(result.rno + '번 댓글이 수정 완료');
		   //다시 modal클릭했을 때, 빈 값 나오게
		   replyText.value = '';
		   modifyModal.hide();
		   printReplies(page,size);
	   }).catch(e => {
		   console.log(e);
	   });
   },false);
   
   /*댓글 삭제 이벤트 등록*/
   removeBtn.addEventListener("click",function(e){
	   removeReply(replyHeader.innerHTML).then(result => {
		   alert(result.rno + '번 댓글이 삭제 완료');
		   replyText.value = '';
		   modifyModal.hide();
		   page=1;
		   printReplies(page,size);
	   }).catch(e => {
		   console.log(e);
	   })
   },false);
   
   closeModifyBtn.addEventListener("click", function (e){
	 		modifyModal.hide()
   },false);
   
</script>